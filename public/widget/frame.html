<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Curbe Chat Widget</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    :root {
      --primary-color: #1D4ED8;
      --primary-hover: #1E40AF;
      --bg-color: #ffffff;
      --text-color: #1f2937;
      --text-secondary: #6b7280;
      --border-color: #e5e7eb;
      --message-bg-incoming: #f3f4f6;
      --message-bg-outgoing: var(--primary-color);
      --message-text-outgoing: #ffffff;
    }
    
    .dark {
      --bg-color: #1f2937;
      --text-color: #f9fafb;
      --text-secondary: #9ca3af;
      --border-color: #374151;
      --message-bg-incoming: #374151;
    }
    
    html, body {
      height: 100%;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: var(--bg-color);
      color: var(--text-color);
    }
    
    .widget-container {
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    
    .widget-header {
      background: var(--primary-color);
      color: white;
      padding: 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      flex-shrink: 0;
    }
    
    .widget-header-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(255,255,255,0.2);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .widget-header-avatar svg {
      width: 24px;
      height: 24px;
      fill: white;
    }
    
    .widget-header-info {
      flex: 1;
    }
    
    .widget-header-title {
      font-weight: 600;
      font-size: 16px;
    }
    
    .widget-header-subtitle {
      font-size: 13px;
      opacity: 0.9;
    }
    
    .widget-header-close {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      padding: 8px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }
    
    .widget-header-close:hover {
      background: rgba(255,255,255,0.1);
    }
    
    .widget-header-close svg {
      width: 20px;
      height: 20px;
    }
    
    .widget-content {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .welcome-section {
      text-align: center;
      padding: 32px 16px;
    }
    
    .welcome-icon {
      width: 64px;
      height: 64px;
      margin: 0 auto 16px;
      background: var(--primary-color);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .welcome-icon svg {
      width: 32px;
      height: 32px;
      fill: white;
    }
    
    .welcome-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 8px;
    }
    
    .welcome-message {
      color: var(--text-secondary);
      font-size: 14px;
      line-height: 1.5;
    }
    
    .reply-time {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin-top: 16px;
      padding: 8px 12px;
      background: var(--message-bg-incoming);
      border-radius: 20px;
      font-size: 13px;
      color: var(--text-secondary);
    }
    
    .reply-time svg {
      width: 16px;
      height: 16px;
      fill: currentColor;
    }
    
    .messages-container {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .message {
      max-width: 85%;
      padding: 10px 14px;
      border-radius: 16px;
      font-size: 14px;
      line-height: 1.4;
      word-wrap: break-word;
    }
    
    .message.incoming {
      align-self: flex-start;
      background: var(--message-bg-incoming);
      border-bottom-left-radius: 4px;
    }
    
    .message.outgoing {
      align-self: flex-end;
      background: var(--message-bg-outgoing);
      color: var(--message-text-outgoing);
      border-bottom-right-radius: 4px;
    }
    
    .message-time {
      font-size: 11px;
      opacity: 0.7;
      margin-top: 4px;
    }
    
    .typing-indicator {
      display: none;
      align-items: center;
      gap: 4px;
      padding: 12px 16px;
      background: var(--message-bg-incoming);
      border-radius: 16px;
      width: fit-content;
    }
    
    .typing-indicator.visible {
      display: flex;
    }
    
    .typing-indicator span {
      width: 8px;
      height: 8px;
      background: var(--text-secondary);
      border-radius: 50%;
      animation: bounce 1.4s infinite ease-in-out both;
    }
    
    .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
    .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
    
    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0.6); }
      40% { transform: scale(1); }
    }
    
    .pre-chat-form {
      padding: 16px;
    }
    
    .form-group {
      margin-bottom: 16px;
    }
    
    .form-label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 6px;
    }
    
    .form-input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 14px;
      background: var(--bg-color);
      color: var(--text-color);
      transition: border-color 0.2s;
    }
    
    .form-input:focus {
      outline: none;
      border-color: var(--primary-color);
    }
    
    .form-submit {
      width: 100%;
      padding: 12px;
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .form-submit:hover {
      background: var(--primary-hover);
    }
    
    .widget-footer {
      padding: 12px 16px;
      border-top: 1px solid var(--border-color);
      flex-shrink: 0;
    }
    
    .message-input-container {
      display: flex;
      gap: 8px;
      align-items: flex-end;
    }
    
    .message-input {
      flex: 1;
      padding: 10px 14px;
      border: 1px solid var(--border-color);
      border-radius: 20px;
      font-size: 14px;
      resize: none;
      max-height: 120px;
      background: var(--bg-color);
      color: var(--text-color);
    }
    
    .message-input:focus {
      outline: none;
      border-color: var(--primary-color);
    }
    
    .send-button {
      width: 40px;
      height: 40px;
      border: none;
      background: var(--primary-color);
      color: white;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
      flex-shrink: 0;
    }
    
    .send-button:hover {
      background: var(--primary-hover);
    }
    
    .send-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .send-button svg {
      width: 20px;
      height: 20px;
      fill: currentColor;
    }
    
    .powered-by {
      text-align: center;
      padding: 8px;
      font-size: 11px;
      color: var(--text-secondary);
    }
    
    .powered-by a {
      color: var(--primary-color);
      text-decoration: none;
    }
    
    .hidden { display: none !important; }
    
    .loading-spinner {
      width: 24px;
      height: 24px;
      border: 2px solid var(--border-color);
      border-top-color: var(--primary-color);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 40px auto;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="widget-container" id="widget">
    <header class="widget-header">
      <div class="widget-header-avatar">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/>
        </svg>
      </div>
      <div class="widget-header-info">
        <div class="widget-header-title" id="headerTitle">Chat with us</div>
        <div class="widget-header-subtitle" id="headerSubtitle">We typically reply within minutes</div>
      </div>
      <button class="widget-header-close" id="closeButton" data-testid="widget-close-button">
        <svg viewBox="0 0 24 24" fill="currentColor">
          <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
        </svg>
      </button>
    </header>
    
    <div class="widget-content" id="content">
      <div class="loading-spinner" id="loadingSpinner"></div>
      
      <div class="welcome-section hidden" id="welcomeSection">
        <div class="welcome-icon">
          <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/>
          </svg>
        </div>
        <h2 class="welcome-title" id="welcomeTitle">Welcome!</h2>
        <p class="welcome-message" id="welcomeMessage">Ask us anything, or share your feedback.</p>
        <div class="reply-time" id="replyTime">
          <svg viewBox="0 0 24 24">
            <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/>
          </svg>
          <span id="replyTimeText">Usually replies in a few minutes</span>
        </div>
      </div>
      
      <div class="pre-chat-form hidden" id="preChatForm">
        <div class="form-group">
          <label class="form-label" for="nameInput">Name</label>
          <input type="text" class="form-input" id="nameInput" placeholder="Your name" data-testid="prechat-name-input">
        </div>
        <div class="form-group">
          <label class="form-label" for="emailInput">Email</label>
          <input type="email" class="form-input" id="emailInput" placeholder="your@email.com" data-testid="prechat-email-input">
        </div>
        <button class="form-submit" id="startChatButton" data-testid="prechat-submit-button">Start Conversation</button>
      </div>
      
      <div class="messages-container hidden" id="messagesContainer"></div>
      
      <div class="typing-indicator" id="typingIndicator">
        <span></span><span></span><span></span>
      </div>
    </div>
    
    <footer class="widget-footer">
      <div class="message-input-container">
        <textarea 
          class="message-input" 
          id="messageInput" 
          placeholder="Type your message..." 
          rows="1"
          data-testid="message-input"
        ></textarea>
        <button class="send-button" id="sendButton" data-testid="send-button" disabled>
          <svg viewBox="0 0 24 24">
            <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
          </svg>
        </button>
      </div>
      <div class="powered-by" id="poweredBy">
        Powered by <a href="https://curbe.io" target="_blank" rel="noopener">Curbe</a>
      </div>
    </footer>
  </div>

  <script>
    (function() {
      'use strict';
      
      var state = {
        token: null,
        websiteToken: null,
        config: null,
        contact: null,
        conversation: null,
        messages: [],
        isLoading: true,
        locale: 'en',
        darkMode: false,
        baseUrl: '',
        pollInterval: null
      };
      
      var elements = {};
      
      function init() {
        cacheElements();
        parseUrlParams();
        setupEventListeners();
        if (state.darkMode) {
          document.documentElement.classList.add('dark');
        }
        if (state.token && state.websiteToken) {
          loadConfig();
        } else {
          showError('Missing authentication token');
        }
      }
      
      function cacheElements() {
        elements = {
          loadingSpinner: document.getElementById('loadingSpinner'),
          welcomeSection: document.getElementById('welcomeSection'),
          preChatForm: document.getElementById('preChatForm'),
          messagesContainer: document.getElementById('messagesContainer'),
          typingIndicator: document.getElementById('typingIndicator'),
          messageInput: document.getElementById('messageInput'),
          sendButton: document.getElementById('sendButton'),
          closeButton: document.getElementById('closeButton'),
          startChatButton: document.getElementById('startChatButton'),
          nameInput: document.getElementById('nameInput'),
          emailInput: document.getElementById('emailInput'),
          headerTitle: document.getElementById('headerTitle'),
          headerSubtitle: document.getElementById('headerSubtitle'),
          welcomeTitle: document.getElementById('welcomeTitle'),
          welcomeMessage: document.getElementById('welcomeMessage'),
          replyTimeText: document.getElementById('replyTimeText'),
          poweredBy: document.getElementById('poweredBy')
        };
      }
      
      function parseUrlParams() {
        var params = new URLSearchParams(window.location.search);
        state.token = params.get('token');
        state.websiteToken = params.get('websiteToken');
        state.locale = params.get('locale') || 'en';
        state.darkMode = params.get('darkMode') === '1';
        state.baseUrl = window.location.origin;
      }
      
      function setupEventListeners() {
        elements.closeButton.addEventListener('click', function() {
          postToParent({ event: 'curbe:close' });
        });
        
        elements.messageInput.addEventListener('input', function() {
          elements.sendButton.disabled = !this.value.trim();
          autoResizeTextarea(this);
        });
        
        elements.messageInput.addEventListener('keydown', function(e) {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
          }
        });
        
        elements.sendButton.addEventListener('click', sendMessage);
        elements.startChatButton.addEventListener('click', startConversation);
        
        window.addEventListener('message', handleParentMessage);
      }
      
      function handleParentMessage(event) {
        var data = event.data;
        if (!data || !data.event) return;
        
        switch (data.event) {
          case 'curbe:config':
            if (data.config) {
              Object.assign(state, {
                config: data.config,
                token: data.token || state.token,
                sessionData: data.sessionData
              });
            }
            break;
          case 'curbe:widget:opened':
            if (state.conversation) {
              loadMessages();
            }
            break;
          case 'curbe:widget:closed':
            break;
          case 'curbe:locale':
            state.locale = data.locale;
            updateLocale();
            break;
          case 'curbe:user:identified':
            state.contact = data.contact;
            break;
        }
      }
      
      function postToParent(data) {
        if (window.parent !== window) {
          window.parent.postMessage(data, '*');
        }
      }
      
      function loadConfig() {
        request('GET', '/api/widget/config/' + state.websiteToken)
          .then(function(config) {
            state.config = config;
            applyConfig(config);
            loadContact();
          })
          .catch(function(error) {
            console.error('Failed to load config:', error);
            showError('Failed to load widget configuration');
          });
      }
      
      function applyConfig(config) {
        if (config.widgetColor) {
          document.documentElement.style.setProperty('--primary-color', config.widgetColor);
        }
        if (config.welcomeTitle) {
          elements.welcomeTitle.textContent = config.welcomeTitle;
          elements.headerTitle.textContent = config.welcomeTitle;
        }
        if (config.welcomeTagline) {
          elements.welcomeMessage.textContent = config.welcomeTagline;
        }
        if (config.replyTime) {
          elements.replyTimeText.textContent = getReplyTimeText(config.replyTime);
          elements.headerSubtitle.textContent = getReplyTimeText(config.replyTime);
        }
        if (!config.showBranding) {
          elements.poweredBy.classList.add('hidden');
        }
      }
      
      function getReplyTimeText(replyTime) {
        var texts = {
          'in_a_few_minutes': 'Usually replies in a few minutes',
          'in_a_few_hours': 'Usually replies in a few hours',
          'in_a_day': 'Usually replies in a day'
        };
        return texts[replyTime] || texts['in_a_few_minutes'];
      }
      
      function loadContact() {
        request('GET', '/api/widget/contacts/me', null, {
          'Authorization': 'Bearer ' + state.token
        })
        .then(function(response) {
          state.contact = response.contact;
          loadConversations();
        })
        .catch(function(error) {
          console.error('Failed to load contact:', error);
          showWelcome();
        });
      }
      
      function loadConversations() {
        request('GET', '/api/widget/conversations', null, {
          'Authorization': 'Bearer ' + state.token
        })
        .then(function(response) {
          var conversations = response.conversations || [];
          var openConvo = conversations.find(function(c) {
            return c.status === 'open' || c.status === 'pending';
          });
          
          if (openConvo) {
            state.conversation = openConvo;
            loadMessages();
          } else {
            showWelcome();
          }
        })
        .catch(function(error) {
          console.error('Failed to load conversations:', error);
          showWelcome();
        });
      }
      
      function loadMessages() {
        if (!state.conversation) return;
        
        request('GET', '/api/widget/conversations/' + state.conversation.id + '/messages', null, {
          'Authorization': 'Bearer ' + state.token
        })
        .then(function(response) {
          state.messages = response.messages || [];
          renderMessages();
          startPolling();
        })
        .catch(function(error) {
          console.error('Failed to load messages:', error);
        });
      }
      
      function showWelcome() {
        state.isLoading = false;
        elements.loadingSpinner.classList.add('hidden');
        elements.welcomeSection.classList.remove('hidden');
        
        if (state.config && state.config.preChatFormEnabled) {
          elements.preChatForm.classList.remove('hidden');
        }
      }
      
      function startConversation() {
        var name = elements.nameInput.value.trim();
        var email = elements.emailInput.value.trim();
        
        if (state.config && state.config.preChatFormEnabled) {
          if (!name || !email) {
            alert('Please fill in all required fields');
            return;
          }
        }
        
        var preChatData = {};
        if (name) preChatData.fullName = name;
        if (email) preChatData.email = email;
        
        request('POST', '/api/widget/conversations', {
          preChatFormData: Object.keys(preChatData).length > 0 ? preChatData : undefined
        }, {
          'Authorization': 'Bearer ' + state.token
        })
        .then(function(response) {
          state.conversation = response.conversation;
          elements.welcomeSection.classList.add('hidden');
          elements.preChatForm.classList.add('hidden');
          elements.messagesContainer.classList.remove('hidden');
          startPolling();
        })
        .catch(function(error) {
          console.error('Failed to create conversation:', error);
        });
      }
      
      function sendMessage() {
        var content = elements.messageInput.value.trim();
        if (!content) return;
        
        if (!state.conversation) {
          request('POST', '/api/widget/conversations', {
            message: content
          }, {
            'Authorization': 'Bearer ' + state.token
          })
          .then(function(response) {
            state.conversation = response.conversation;
            elements.welcomeSection.classList.add('hidden');
            elements.preChatForm.classList.add('hidden');
            elements.messagesContainer.classList.remove('hidden');
            
            addLocalMessage(content);
            elements.messageInput.value = '';
            elements.sendButton.disabled = true;
            autoResizeTextarea(elements.messageInput);
            startPolling();
          })
          .catch(function(error) {
            console.error('Failed to send message:', error);
          });
          return;
        }
        
        var tempId = 'temp_' + Date.now();
        addLocalMessage(content, tempId);
        elements.messageInput.value = '';
        elements.sendButton.disabled = true;
        autoResizeTextarea(elements.messageInput);
        
        request('POST', '/api/widget/conversations/' + state.conversation.id + '/messages', {
          content: content,
          contentType: 'text',
          echoId: tempId
        }, {
          'Authorization': 'Bearer ' + state.token
        })
        .then(function(response) {
          var tempMsg = state.messages.find(function(m) { return m.id === tempId; });
          if (tempMsg) {
            tempMsg.id = response.message.id;
            tempMsg.status = 'sent';
          }
        })
        .catch(function(error) {
          console.error('Failed to send message:', error);
          var failedMsg = state.messages.find(function(m) { return m.id === tempId; });
          if (failedMsg) {
            failedMsg.status = 'failed';
            renderMessages();
          }
        });
      }
      
      function addLocalMessage(content, id) {
        var message = {
          id: id || 'local_' + Date.now(),
          content: content,
          messageType: 'outgoing',
          createdAt: new Date().toISOString(),
          status: 'sending'
        };
        state.messages.push(message);
        renderMessages();
        scrollToBottom();
      }
      
      function renderMessages() {
        elements.loadingSpinner.classList.add('hidden');
        elements.welcomeSection.classList.add('hidden');
        elements.preChatForm.classList.add('hidden');
        elements.messagesContainer.classList.remove('hidden');
        
        var html = state.messages.map(function(msg) {
          var isOutgoing = msg.messageType === 'outgoing';
          var time = formatTime(msg.createdAt);
          return '<div class="message ' + (isOutgoing ? 'outgoing' : 'incoming') + '" data-testid="message-' + msg.id + '">' +
            '<div class="message-content">' + escapeHtml(msg.content) + '</div>' +
            '<div class="message-time">' + time + '</div>' +
          '</div>';
        }).join('');
        
        elements.messagesContainer.innerHTML = html;
        scrollToBottom();
      }
      
      function scrollToBottom() {
        var content = document.getElementById('content');
        content.scrollTop = content.scrollHeight;
      }
      
      function startPolling() {
        if (state.pollInterval) return;
        state.pollInterval = setInterval(pollMessages, 3000);
      }
      
      function stopPolling() {
        if (state.pollInterval) {
          clearInterval(state.pollInterval);
          state.pollInterval = null;
        }
      }
      
      function pollMessages() {
        if (!state.conversation) return;
        
        request('GET', '/api/widget/conversations/' + state.conversation.id + '/messages?limit=50', null, {
          'Authorization': 'Bearer ' + state.token
        })
        .then(function(response) {
          var newMessages = response.messages || [];
          var hasNew = newMessages.length !== state.messages.length;
          
          if (hasNew) {
            var existingIds = state.messages.map(function(m) { return m.id; });
            var incomingNew = newMessages.filter(function(m) {
              return !existingIds.includes(m.id) && m.messageType === 'incoming';
            });
            
            if (incomingNew.length > 0) {
              postToParent({ 
                event: 'curbe:message:received', 
                message: incomingNew[incomingNew.length - 1] 
              });
              postToParent({ 
                event: 'curbe:unreadCount', 
                count: incomingNew.length 
              });
            }
            
            state.messages = newMessages;
            renderMessages();
          }
        })
        .catch(function(error) {
          console.error('Poll failed:', error);
        });
      }
      
      function showError(message) {
        elements.loadingSpinner.classList.add('hidden');
        elements.welcomeSection.classList.remove('hidden');
        elements.welcomeTitle.textContent = 'Error';
        elements.welcomeMessage.textContent = message;
      }
      
      function updateLocale() {
        // Placeholder for locale updates
      }
      
      function autoResizeTextarea(textarea) {
        textarea.style.height = 'auto';
        textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
      }
      
      function formatTime(dateString) {
        var date = new Date(dateString);
        return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      }
      
      function escapeHtml(text) {
        var div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }
      
      function request(method, url, body, headers) {
        return new Promise(function(resolve, reject) {
          var xhr = new XMLHttpRequest();
          xhr.open(method, state.baseUrl + url, true);
          xhr.setRequestHeader('Content-Type', 'application/json');
          
          if (headers) {
            Object.keys(headers).forEach(function(key) {
              xhr.setRequestHeader(key, headers[key]);
            });
          }
          
          xhr.onreadystatechange = function() {
            if (xhr.readyState === 4) {
              if (xhr.status >= 200 && xhr.status < 300) {
                try {
                  resolve(JSON.parse(xhr.responseText));
                } catch (e) {
                  resolve(xhr.responseText);
                }
              } else {
                var error = new Error('Request failed');
                error.status = xhr.status;
                reject(error);
              }
            }
          };
          
          xhr.onerror = function() {
            reject(new Error('Network error'));
          };
          
          xhr.send(body ? JSON.stringify(body) : null);
        });
      }
      
      postToParent({ event: 'curbe:ready' });
      
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }
    })();
  </script>
</body>
</html>
