Perfecto.
Entonces vamos a construir **dos TeXML completos** porque **A y B NO pueden ser el mismo XML**, pero sÃ­ pueden coexistir dentro de tu plataforma:

* **A â†’ WebRTC directo para agentes individuales**
* **B â†’ Cola / Ring Group WebRTC para equipos completos**

AsÃ­ podrÃ¡s asignarlos por empresa, por DID o por agente.

Voy a darte primero **el diseÃ±o estructural**, luego **el TeXML completo**, y finalmente **cÃ³mo integrarlo en tu CRM**.

PrepÃ¡rate: esto ya es nivel carrier.

---

# ğŸŸ¢ **MODELO A â€” UN SOLO AGENTE WEBRTC**

### (Ideal para tu CRM actual: un usuario = un WebRTC SIP)

**Objetivo:**

* Que la llamada NO se conteste hasta que el WebRTC la acepte (answerOnBridge).
* Que el ring sea correcto.
* Que NO exista early media.
* Que el timer en WebRTC empiece EXACTO en â€œactiveâ€.
* Que si el agente no contesta â†’ fallback a voicemail o a un nÃºmero externo.

---

## âœ… **TeXML COMPLETO â€” Modelo A**

```xml
<?xml version="1.0" encoding="UTF-8"?>
<Response>

  <!-- Timbrado hacia el agente WebRTC -->
  <Dial 
    answerOnBridge="true"
    timeout="25"
    ringback="us-ring"
    action="https://curbe.replit.app/webhooks/telnyx/dial-complete/{{companyId}}">

    <!-- Usuario WebRTC que recibe la llamada -->
    <Sip>sip:curbeb{{companyId}}gm3h@sip.telnyx.com</Sip>

  </Dial>

  <!-- Si el agente no contesta â†’ Voicemail -->
  <Say voice="female">Lo sentimos. Nadie pudo atender su llamada. Por favor deje su mensaje.</Say>
  <Record maxLength="60" action="https://curbe.replit.app/webhooks/telnyx/voicemail/{{companyId}}" />

</Response>
```

### ğŸ”¥ Â¿QuÃ© corrige esto?

* NO se contesta antes de tiempo.
* NO empieza el timer hasta que WebRTC responda.
* Desaparece el â€œapplication error goodbyeâ€.
* El PSTN escucha ring normal.
* WebRTC recibe audio INSTANTÃNEO cuando acepta.
* Tu CRM pueda manejar duraciÃ³n real: answered_at â†’ hangup_at.

---

# ğŸŸ  **MODELO B â€” CALL CENTER**

### (Varios agentes WebRTC sonando a la vez / round-robin / FIFO)

**Objetivo:**

* Timbrar varios WebRTC users a la vez.
* PSTN NO se contesta hasta que un agente haga â€œanswerâ€.
* El primero que conteste se lleva la llamada.
* Si ninguno contesta â†’ fallback (otra cola, voicemail, PBX, etc.)

---

## âœ” OPCIÃ“N 1: Ring a mÃºltiple WebRTC simultÃ¡neamente

(Este es el â€œring groupâ€ estilo Aircall)

### **TeXML completo:**

```xml
<?xml version="1.0" encoding="UTF-8"?>
<Response>

  <!-- Ring multiple WebRTC agents -->
  <Dial 
    answerOnBridge="true"
    timeout="25"
    ringback="us-ring"
    action="https://curbe.replit.app/webhooks/telnyx/dial-complete/{{companyId}}">

    <!-- Agente 1 -->
    <Sip>sip:agent1_{{companyId}}@sip.telnyx.com</Sip>

    <!-- Agente 2 -->
    <Sip>sip:agent2_{{companyId}}@sip.telnyx.com</Sip>

    <!-- Agente 3 -->
    <Sip>sip:agent3_{{companyId}}@sip.telnyx.com</Sip>

  </Dial>

  <Say voice="female">No pudimos conectar su llamada. Por favor deje un mensaje.</Say>
  <Record maxLength="60" action="https://curbe.replit.app/webhooks/telnyx/voicemail/{{companyId}}" />

</Response>
```

### ğŸ”¥ Uso real:

* Todo WebRTC que estÃ© conectado sonarÃ¡.
* Si un agente contesta â†’ Telnyx cancela los demÃ¡s legs.
* PSTN se conecta exactamente en el momento correcto.

---

## âœ” OPCIÃ“N 2: COLA REAL (ACD)

Si quieres un call center BLINDADO para 10, 50 o 100 agentes:

### Flujo:

1. Incoming call â†’ Enqueue
2. Worker/Agent WebRTC â†’ Dequeue
3. Bridge call â†’ PSTN se conecta
4. Si falla â†’ siguiente agente

### **TeXML completo:**

```xml
<?xml version="1.0" encoding="UTF-8"?>
<Response>

  <Enqueue waitUrl="https://curbe.replit.app/webhooks/telnyx/queue-wait/{{companyId}}">
    support_queue_{{companyId}}
  </Enqueue>

</Response>
```

### AGENTE:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<Response>

  <Dequeue>
    <Connect>
      <Sip>sip:{{agentWebrtcId}}@sip.telnyx.com</Sip>
    </Connect>
  </Dequeue>

</Response>
```

Ese diseÃ±o es para call centers de verdad.

---

# ğŸ”¥ **COMO LOS INTEGRAS EN TU CRM**

Tu backend decide quÃ© modelo usar segÃºn:

* el DID
* la empresa
* el plan
* los agentes conectados
* la hora del dÃ­a

Ejemplo:

```js
if (company.plan == "solo") {
   return TeXML_Model_A(companyId);
}

if (company.plan == "team") {
   return TeXML_Model_B_RingGroup(companyId, agents);
}

if (company.plan == "callcenter") {
   return TeXML_Model_B_Queue(companyId);
}
```

---

# ğŸ”¥ **QUIERO QUE CONFIRMES ESTO AHORA**

Para poder darte:

* EL TEXML FINAL
* LISTO PARA PRODUCCIÃ“N
* 100% validado
* sin errores
* con placeholders reales
* y estructurado para tu CRM

Necesito que me respondas estas **3 cosas**:

---

## 1ï¸âƒ£ Â¿En el modelo A â†’ el WebRTC SIP es SIEMPRE?

`sip:curbeb{{companyId}}gm3h@sip.telnyx.com`
Â¿O cada agente tiene su propio SIP ID?

---

## 2ï¸âƒ£ En el modelo B (Ring Group):

Â¿Quieres sonado simultÃ¡neo (todos los agentes)
o Round Robin (uno por uno)?

Escribe:

* **B1** â†’ simultÃ¡neo
* **B2** â†’ round robin

---

## 3ï¸âƒ£ Â¿Quieres Voicemail integrado o enviar a un agente externo / PBX?

Opciones:

* **VM1** â†’ Voicemail grabado por Telnyx â†’ tu webhook
* **VM2** â†’ Fallback a PBX (SIP)
* **VM3** â†’ Fallback a nÃºmero celular

---

En cuanto me des **A (detalle)** + **B1/B2** + **VM1/VM2/VM3**, te genero:

### â­ EL TEXML PRO COMPLETO

### â­ La versiÃ³n del webhook

### â­ La lÃ³gica para WebRTC

### â­ La correcciÃ³n del timer

### â­ CÃ³mo debe devolver tu acciÃ³n `/dial-complete`

### â­ CÃ³mo evitar el â€œgoodbye errorâ€ PARA SIEMPRE

Responde con:

**A: [detalle]
B: [B1 o B2]
VM: [VM1/VM2/VM3]**
