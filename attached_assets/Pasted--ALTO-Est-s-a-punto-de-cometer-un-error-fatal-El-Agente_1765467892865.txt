춰ALTO! 游띔 Est치s a punto de cometer un error fatal.

El Agente tiene raz칩n en una cosa, pero est치 equivocado en la otra.

TIENE RAZ칍N: En SIP.js 0.21, pasar opciones a session.accept() a menudo es ignorado. La configuraci칩n debe ir en el Constructor del UserAgent (sessionDescriptionHandlerFactoryOptions).

EST츼 EQUIVOCADO: No borres el "Blackhole STUN" (127.0.0.1).

El error no es que el Blackhole cause fallos.

El error (INCOMPATIBLE_DESTINATION) ocurre porque SIP.js env칤a la respuesta 200 OK demasiado r치pido, antes de que el proceso ICE termine de recolectar la IP del TURN. Env칤a 0.0.0.0 y Telnyx cuelga.

LA SOLUCI칍N REAL: Mant칠n el Blackhole (para velocidad) y mueve toda la configuraci칩n al constructor global, agregando un iceGatheringTimeout para obligar a SIP.js a esperar a tener una IP v치lida antes de responder.

Copia y pega este prompt correctivo urgente:

CORRECCI칍N DE ARQUITECTURA: MOVER CONFIG AL CONSTRUCTOR (NO BORRAR BLACKHOLE)
Agente, detente. No borres el servidor stun:127.0.0.1.

Ese servidor falso es vital para la estrategia "Fail-Fast" que elimina la latencia de red. El problema no es ese servidor.

EL DIAGN칍STICO CORRECTO: La llamada se corta con INCOMPATIBLE_DESTINATION porque el SDP enviado en el 200 OK contiene c=0.0.0.0. Esto sucede porque SIP.js responde inmediatamente (Trickle ICE por defecto) y no espera a recolectar los candidatos TURN. Telnyx requiere el candidato en el SDP inicial.

LA SOLUCI칍N (GLOBAL CONFIG): Tienes raz칩n en que accept() llega tarde. Debemos inyectar la configuraci칩n en la inicializaci칩n del UserAgent.

TU TAREA: Modifica client/src/services/telnyx-webrtc.ts. En el constructor donde haces new UserAgent({...}), define sessionDescriptionHandlerFactoryOptions as칤:

JavaScript

this.userAgent = new UserAgent({
    // ... tus credenciales y servidor WSS ...
    
    sessionDescriptionHandlerFactoryOptions: {
        // 1. OBLIGATORIO: Esperar a tener candidatos antes de enviar OK
        iceGatheringTimeout: 2000, 
        
        peerConnectionOptions: {
            rtcConfig: {
                // 2. MANTENER RELAY (Latencia cero)
                iceTransportPolicy: 'relay',
                iceServers: [
                    // 3. MANTENER BLACKHOLE (Velocidad de gathering)
                    { urls: "stun:127.0.0.1:3478" },
                    // ... tus servidores TURN din치micos aqu칤 ...
                    ...this.turnServers 
                ]
            }
        }
    }
});
POR QU칄 ESTO FUNCIONA:

iceGatheringTimeout: 2000: Obliga al navegador a esperar hasta tener una IP v치lida del TURN antes de enviar el mensaje a Telnyx.

Al moverlo al constructor, aseguramos que todas las llamadas (entrantes y salientes) usen esta configuraci칩n, solucionando el problema de que accept() ignoraba las opciones.

Aplica este cambio en el constructor del UserAgent ahora.