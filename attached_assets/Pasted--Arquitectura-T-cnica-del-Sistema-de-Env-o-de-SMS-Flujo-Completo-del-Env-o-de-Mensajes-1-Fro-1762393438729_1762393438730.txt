üì± Arquitectura T√©cnica del Sistema de Env√≠o de SMS
üèóÔ∏è Flujo Completo del Env√≠o de Mensajes
1Ô∏è‚É£ Frontend (React + TypeScript)
Ubicaci√≥n: client/src/pages/send-sms.tsx

Entrada del Usuario:
// El usuario ingresa:
- N√∫mero de tel√©fono (ej: +13053936666)
- Mensaje de texto (hasta 1600 caracteres)

Validaci√≥n Frontend:
if (!singlePhone || !singleMessage) {
  toast({ title: "Error", description: "Completa todos los campos" });
  return;
}

Env√≠o mediante React Query:
const sendSingleMutation = useMutation({
  mutationFn: async (data: { to: string; message: string }) =>
    apiRequest("POST", "/api/messages/send", data),
});
// Ejecuta:
sendSingleMutation.mutate({ 
  to: "+13053936666", 
  message: "Hola mundo" 
});

Request HTTP:

POST /api/messages/send
Content-Type: application/json
{
  "to": "+13053936666",
  "message": "Hola mundo"
}

2Ô∏è‚É£ Backend - API Route (Express.js)
Ubicaci√≥n: server/routes.ts l√≠neas 66-109

Recepci√≥n y Validaci√≥n:
app.post("/api/messages/send", async (req, res) => {
  const { to, message } = req.body;
  
  // Validaci√≥n
  if (!to || !message) {
    return res.status(400).json({ 
      message: "Campos requeridos: to, message" 
    });
  }

Configuraci√≥n Autom√°tica:
// Campaign ID desde variable de entorno
const campaignId = process.env.BULKVS_CAMPAIGN_ID; // "C3JXHXH"
// N√∫mero remitente desde variable de entorno
const fromDisplay = campaignId || process.env.BULKVS_FROM_DID; // "13058458282"

Llamada al Cliente BulkVS:
const result = await bulkVSClient.sendSMS({
  to: "+13053936666",
  from: "C3JXHXH",
  message: "Hola mundo",
  campaignId: "C3JXHXH"
});

3Ô∏è‚É£ BulkVS Client (Capa de Integraci√≥n)
Ubicaci√≥n: server/bulkvs.ts l√≠neas 43-69

Inicializaci√≥n (Singleton):
export class BulkVSClient {
  private client: AxiosInstance;
  private username: string;     // BULKVS_API_USERNAME
  private password: string;     // BULKVS_API_PASSWORD
  private defaultFromDid: string; // "13058458282"
  
  constructor() {
    // Autenticaci√≥n Basic Auth
    const authHeader = Buffer.from(
      `${this.username}:${this.password}`
    ).toString("base64");
    
    this.client = axios.create({
      baseURL: "https://portal.bulkvs.com/api/v1.0",
      headers: {
        "Authorization": `Basic ${authHeader}`,
        "Content-Type": "application/json"
      }
    });
  }
}

Transformaci√≥n de Datos:
async sendSMS(params: BulkVSMessage) {
  // BulkVS requiere formato espec√≠fico
  const payload = {
    From: "13058458282",              // Solo d√≠gitos, sin +
    To: ["13053936666"],              // Array, solo d√≠gitos
    Message: "Hola mundo"             // Texto sin modificar
  };
  
  // Env√≠o a BulkVS
  const response = await this.client.post("/messageSend", payload);
}

Reglas de Transformaci√≥n:

Campos capitalizados: From, To, Message (no from, to, message)
N√∫meros limpios: Remover + y caracteres no num√©ricos
To como array: ["13053936666"] no "13053936666"
From desde env: Siempre usar BULKVS_FROM_DID (13058458282)
4Ô∏è‚É£ BulkVS API (Servicio Externo)
Endpoint: https://portal.bulkvs.com/api/v1.0/messageSend

Request HTTP Real:
POST /api/v1.0/messageSend HTTP/1.1
Host: portal.bulkvs.com
Authorization: Basic dXNlcm5hbWU6cGFzc3dvcmQ=
Content-Type: application/json
{
  "From": "13058458282",
  "To": ["13053936666"],
  "Message": "Hola mundo"
}

Response Exitosa:
{
  "Results": [
    {
      "Status": "SUCCESS",
      "RefId": "A1B2C3D4",
      "To": "13053936666"
    }
  ]
}

Response con Error:
{
  "error": "Invalid phone number",
  "code": 400
}

5Ô∏è‚É£ Procesamiento de Respuesta (Backend)
Ubicaci√≥n: server/bulkvs.ts l√≠neas 55-68

Extracci√≥n de Datos:
const response = await this.client.post("/messageSend", payload);
return {
  success: true,
  messageId: response.data?.RefId,           // "A1B2C3D4"
  status: response.data?.Results?.[0]?.Status === "SUCCESS" 
    ? "delivered" 
    : "sent"
};

Manejo de Errores:
catch (error: any) {
  console.error("Error sending SMS:", error.response?.data);
  return {
    success: false,
    error: error.response?.data || error.message
  };
}

6Ô∏è‚É£ Persistencia en Storage (In-Memory)
Ubicaci√≥n: server/routes.ts l√≠neas 96-103

Guardado Exitoso:
const savedMessage = await storage.createMessage({
  to: "+13053936666",
  from: "C3JXHXH",
  message: "Hola mundo",
  status: "delivered",        // De BulkVS
  direction: "outbound",      // Mensaje saliente
  campaignId: null
});

Guardado con Fallo:
if (!result.success) {
  await storage.createMessage({
    to: "+13053936666",
    from: "C3JXHXH",
    message: "Hola mundo",
    status: "failed",         // Marcado como fallido
    direction: "outbound",
    campaignId: null
  });
  return res.status(400).json({ message: result.error });
}

Estructura del Mensaje Guardado:

{
  id: "uuid-v4",              // Generado autom√°ticamente
  to: "+13053936666",
  from: "C3JXHXH",
  message: "Hola mundo",
  status: "delivered",
  direction: "outbound",
  campaignId: null,
  sentAt: "2025-11-05T17:23:38.531Z"
}

7Ô∏è‚É£ Response al Frontend
Ubicaci√≥n: server/routes.ts l√≠nea 105

res.json(savedMessage);

HTTP Response:

HTTP/1.1 200 OK
Content-Type: application/json
{
  "id": "uuid-123",
  "to": "+13053936666",
  "from": "C3JXHXH",
  "message": "Hola mundo",
  "status": "delivered",
  "direction": "outbound",
  "campaignId": null,
  "sentAt": "2025-11-05T17:23:38.531Z"
}

8Ô∏è‚É£ Actualizaci√≥n de UI (React Query)
Ubicaci√≥n: client/src/pages/send-sms.tsx l√≠neas 29-38

onSuccess: () => {
  // Notificaci√≥n al usuario
  toast({
    title: "SMS enviado",
    description: "El mensaje ha sido enviado exitosamente"
  });
  
  // Limpiar formulario
  setSinglePhone("");
  setSingleMessage("");
  
  // Invalidar cach√©s para refrescar datos
  queryClient.invalidateQueries({ queryKey: ["/api/stats"] });
  queryClient.invalidateQueries({ queryKey: ["/api/messages/recent"] });
}

üìä Env√≠o Masivo (Bulk)
Diferencias t√©cnicas:

Backend Loop:
app.post("/api/messages/send-bulk", async (req, res) => {
  const { contacts, message } = req.body; // contacts = ["+1...", "+1..."]
  const results = [];
  
  // Env√≠o secuencial (uno por uno)
  for (const phoneNumber of contacts) {
    const result = await bulkVSClient.sendSMS({
      to: phoneNumber,
      from: fromDisplay,
      message,
      campaignId
    });
    
    const savedMessage = await storage.createMessage({
      to: phoneNumber,
      from: fromDisplay,
      message,
      status: result.success ? result.status : "failed",
      direction: "outbound",
      campaignId: null
    });
    
    results.push(savedMessage);
  }
  
  res.json({ sent: results.length, results });
});

Caracter√≠sticas:

‚ö†Ô∏è Sincr√≥nico: Env√≠a uno por uno (no paralelo)
‚úÖ Trazabilidad: Cada mensaje tiene su propio registro
‚úÖ Tolerante a fallos: Si uno falla, contin√∫a con los dem√°s
‚è±Ô∏è Latencia: ~300ms por mensaje
üîÑ Recepci√≥n de Respuestas (Webhooks)
Configuraci√≥n del Webhook en BulkVS:
URL: https://[tu-app].replit.app/api/webhooks/receiver
Events: inbound_message, message_received
Method: POST

Formato de Webhook de BulkVS:
POST /api/webhooks/receiver HTTP/1.1
Host: tu-app.replit.app
Content-Type: application/json
{
  "RefId": "32C1BD67",
  "From": "17866302522",
  "To": ["13058458282"],
  "FragmentCount": 1,
  "Message": "No+me+digas+que+me+has+dejado+sin+dinero+"
}

Procesamiento del Webhook:
Ubicaci√≥n: server/routes.ts l√≠neas 389-426

app.post("/api/webhooks/receiver", async (req, res) => {
  const { From, To, Message, RefId } = req.body;
  
  // To es array, obtener primer elemento
  const toNumber = Array.isArray(To) ? To[0] : To;
  
  // Decodificar mensaje URL-encoded
  const decodedMessage = decodeURIComponent(
    Message.replace(/\+/g, ' ')
  );
  // "No me digas que me has dejado sin dinero "
  
  // Guardar como mensaje entrante
  await storage.createMessage({
    to: toNumber,           // "13058458282"
    from: From,             // "17866302522"
    message: decodedMessage,
    status: "delivered",
    direction: "inbound",   // ‚Üê CLAVE: Mensaje entrante
    campaignId: null
  });
  
  res.json({ success: true });
});

üîê Variables de Entorno (Secrets)
BULKVS_API_USERNAME=tu_usuario
BULKVS_API_PASSWORD=tu_password
BULKVS_FROM_DID=13058458282
BULKVS_CAMPAIGN_ID=C3JXHXH
BULKVS_API_URL=https://portal.bulkvs.com/api/v1.0
SESSION_SECRET=random_secret_key

‚ö° Rendimiento y Limitaciones
M√©trica	Valor
Latencia promedio (single)	~300ms
Latencia promedio (bulk 10 msgs)	~3s
Throughput m√°ximo	~3-4 msg/s
Timeout por request	120s
Almacenamiento	In-memory (vol√°til)
Persistencia	‚ùå Se pierde al reiniciar
üéØ Puntos Cr√≠ticos de Configuraci√≥n
‚úÖ N√∫mero remitente debe tener servicio outbound habilitado
‚úÖ Campaign ID debe estar aprobado en BulkVS
‚úÖ Campos capitalizados en payload a BulkVS
‚úÖ N√∫meros sin + en comunicaci√≥n con BulkVS
‚úÖ Webhook URL p√∫blica para recibir respuestas