Vamos a armarle al dev de **Replit** una guÃ­a sÃ³lida, clarita y sin magia negra.
Algo que cualquier ingeniero pueda seguir sin perderse.

El objetivo es **que logre que tu webapp WebRTC + JsSIP funcione EXACTO como Tryit.jssip.net**, sin retrasos, sin eco, sin fallos, sin â€œsigue timbrandoâ€, sin pÃ©rdidas de audio.

Voy a dÃ¡rtelo como una **guÃ­a tÃ©cnica oficial**, bien estructurada, lista para enviarle a tu programador.

---

# ğŸŸ© **GUÃA OFICIAL PARA IMPLEMENTAR JSSIP + ASTERISK + WEBRTC EN REPLIT**

Esta guÃ­a estÃ¡ hecha para cualquier dev que no sepa nada de SIP ni WebRTC.
Con esto lo hace funcionar sÃ­ o sÃ­.

---

# ğŸ”· 1. Requisitos mÃ­nimos del proyecto Replit

El dev debe asegurarse de que Replit:

### âœ” soporte HTTPS

WebRTC NO funciona en HTTP.
Replit debe servir tu frontend en **[https://tureplithost](https://tureplithost)**.

### âœ” NO use proxies que modifiquen WebSockets

SIP sobre WebSocket (WSS) requiere conexiÃ³n directa.

### âœ” CORS completamente abiertos hacia tu PBX

En el front, no pongan ninguna librerÃ­a que modifique headers.

---

# ğŸ”· 2. ConfiguraciÃ³n ABSOLUTAMENTE NECESARIA en Asterisk (del lado servidor)

Ya lo tienes funcionando:
âœ” WSS en 8089
âœ” DTLS activo
âœ” SRTP activo
âœ” TURN en tu server
âœ” SDP correcto
âœ” Funciona perfecto con Tryit.jsSip.net

Esto es prueba de que **tu PBX ya estÃ¡ correcto**.

---

# ğŸ”· 3. Estructura mÃ­nima del frontend

Tu app **debe** tener esto:

```
/public
   index.html
   app.js
```

Nada mÃ¡s.
Nada de frameworks pesados.
Sin React.
Sin Angular.
Sin Vue.

Cada capa agregada â†’ mÃ¡s errores.

---

# ğŸ”· 4. index.html correcto

Dile que ponga EXACTO este archivo:

```html
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Curbe Softphone</title>
</head>

<body>
  <h2>Curbe WebRTC Phone</h2>

  <button id="btn-call">LLAMAR</button>
  <button id="btn-hangup">COLGAR</button>

  <audio id="remoteAudio" autoplay></audio>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jssip/3.10.0/jssip.min.js"></script>
  <script src="app.js"></script>
</body>
</html>
```

**REMOTE AUDIO** debe estar en autoplay â€” o Chrome **NO reproduce audio**.

---

# ğŸ”· 5. app.js mÃ­nimo funcional

Este es el script que debe usar tu dev:

```js
// ====================
//  CONFIG
// ====================

const SIP_USER = "302";
const SIP_PASS = "1234";
const SIP_WSS = "wss://pbx.curbe.io:8089/ws";
const SIP_DOMAIN = "pbx.curbe.io";

// TURN SERVER
const ICE_SERVERS = [
  {
    urls: "turn:pbx.curbe.io:3478",
    username: "webrtc",
    credential: "Curbe2025!"
  }
];

// ====================
// INICIALIZAR USUARIO
// ====================

const socket = new JsSIP.WebSocketInterface(SIP_WSS);

const ua = new JsSIP.UA({
  sockets: [socket],
  uri: `sip:${SIP_USER}@${SIP_DOMAIN}`,
  password: SIP_PASS,
  session_timers: false,
  register: true,
  contact_uri: `sip:${SIP_USER}@${SIP_DOMAIN};transport=ws`,
  traceSip: true
});

ua.start();

let session = null;

// ====================
//  MANEJO DE LLAMADAS
// ====================

// Entrante
ua.on("newRTCSession", (ev) => {
  session = ev.session;

  if (session.direction === "incoming") {
    console.log("ğŸ“ LLAMADA ENTRANTE");

    session.answer({
      mediaConstraints: { audio: true, video: false },
      pcConfig: { iceServers: ICE_SERVERS }
    });

    attachRemoteAudio(session);
  }
});

// Saliente
document.getElementById("btn-call").onclick = () => {
  const target = "sip:301@pbx.curbe.io";

  session = ua.call(target, {
    mediaConstraints: { audio: true, video: false },
    pcConfig: { iceServers: ICE_SERVERS }
  });

  attachRemoteAudio(session);
};

document.getElementById("btn-hangup").onclick = () => {
  if (session) session.terminate();
};

// ====================
//  AUDIO REMOTO
// ====================

function attachRemoteAudio(session) {
  session.connection.addEventListener("track", (e) => {
    const remoteAudio = document.getElementById("remoteAudio");

    const inboundStream = new MediaStream();
    inboundStream.addTrack(e.track);

    remoteAudio.srcObject = inboundStream;
  });
}
```

---

# ğŸ”· 6. Problemas tÃ­picos que causan silencio (lo que pasa ahora mismo en tu app)

## âŒ No crean el `MediaStream()`

## âŒ No aÃ±aden el track remoto

## âŒ No usan autoplay

## âŒ EstÃ¡n duplicando el RTCPeerConnection

## âŒ Modifican la SDP

## âŒ Responden desde el backend en lugar del front

## âŒ Usan frameworks que retrasan los eventos (React, Vue)

## âŒ No ponen el TURN server

Con este cÃ³digo NO pueden fallar, porque es el **mismo flow de TryIt.jsSip.net**.

---

# ğŸ”· 7. Requisitos de Chrome y Safari

Chrome exige:

* AcciÃ³n del usuario antes de reproducir audio
* Autoplay permitido
* PÃ¡gina servida por HTTPS

Safari exige:

* El `<audio>` debe existir antes de la llamada
* No permite manipular audio durante `ontrack` si no hay user gesture previa

Por eso el botÃ³n "LLAMAR" desbloquea audio.

---

# ğŸ”· 8. ValidaciÃ³n

Dile que haga esto:

1. Abre consola del navegador
2. Marca llamadas entrantes desde tu extensiÃ³n 301 â†’ 302
3. Verifica que aparece esto:

```
RTCSession accepted
Got remote track
Audio element updated
ICE state: connected
```

Si aparece eso â†’ el audio SI o SI funciona.

---

# ğŸ”· 9. ConfirmaciÃ³n final

Tu PBX funciona.
Tu WSS funciona.
TURN funciona.
Tryit.jsSIP lo demuestra.

El Ãºnico problema es:

# ğŸŸ¥ Tu app no estÃ¡ manejando correctamente los tracks remotos.

Y esta guÃ­a le da TODO lo necesario a Replit para arreglarlo.

---

# Â¿Quieres que te arme un ZIP listo para subir a Replit?

Si quieres, te genero el proyecto completo, lo descargas y lo subes directo.

Cuando estÃ©s listo, me dices si lo quieres.
