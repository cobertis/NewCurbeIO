Tu agente est√° a punto de cometer un **error de arquitectura** que dejar√° a tu sistema inservible para funciones avanzadas (como IVR o Grabaci√≥n).

El agente dijo:
> *"Pero el n√∫mero est√° asignado a la Credencial Connection... y la TeXML Application solo parece usarse para los webhooks de status."*

üö® **ESTO EST√Å MAL.** üö®

Si asignas el n√∫mero directo a la Credencial (SIP Connection), Telnyx se salta tu cerebro (tu Backend). La llamada va directo al tel√©fono "tonto". Pierdes la capacidad de interceptar la llamada para grabar, hacer IVR o transcribir con IA antes de conectar.

Aqu√≠ tienes la correcci√≥n urgente. Tienes que forzar la arquitectura **"App-First"**.

### El Flujo Correcto (Arquitectura CRM)
1.  **N√∫mero de Tel√©fono:** Apunta a la -> **TeXML Application**.
2.  **TeXML Application:** Apunta a tu -> **Webhook (`/inbound`)**.
3.  **Webhook:** Decide qu√© hacer y responde -> **`<Dial><Client>juan</Client></Dial>`**.
4.  **`<Client>`:** Busca la -> **SIP Credential** de Juan y hace sonar su navegador.

### PROMPT DE CORRECCI√ìN DE EMERGENCIA

Dale esto a tu agente inmediatamente para detener la mala configuraci√≥n y arreglar el enrutamiento aleatorio (actualmente est√° enviando la llamada al "primer usuario que encuentre", lo cual es un desastre).

***

> **ALERTA DE ARQUITECTURA: CORRECCI√ìN INMEDIATA**
>
> Detente. Est√°s cometiendo un error cr√≠tico en la asignaci√≥n de recursos que limitar√° nuestras funciones futuras.
>
> **1. Correcci√≥n de Asignaci√≥n (Number Assignment):**
> * Los n√∫meros de tel√©fono **NO** deben asignarse a la "Credential Connection" directamente.
> * **REGLA:** Todos los n√∫meros comprados deben tener su `connection_id` apuntando a la **TeXML Application ID**.
> * *Por qu√©:* Si no pasan por la TeXML App, no se disparan los webhooks de voz y perdemos el control l√≥gico (Grabaci√≥n, IVR, etc.).
> * **Acci√≥n:** Revisa la funci√≥n de compra/configuraci√≥n de n√∫meros y aseg√∫rate de que el `connection_id` sea el de la App, no el de la Credencial SIP.
>
> **2. Correcci√≥n de L√≥gica de Enrutamiento (Webhook):**
> * En tu nuevo c√≥digo del webhook `/inbound`, est√°s haciendo esto:
>   `const credential = ... .limit(1)` (Tomas el primer usuario que encuentras).
> * **ESTO ES INCORRECTO.** No podemos llamar a un agente aleatorio.
> * **L√≥gica Correcta:**
>   1. Busca el n√∫mero llamado (`to`) en la tabla `telnyx_phone_numbers`.
>   2. Mira a qu√© `user_id` o `queue_id` est√° asignado ese n√∫mero espec√≠fico en nuestra DB.
>   3. Busca la credencial SIP de **ESE** usuario espec√≠fico.
>   4. Si el n√∫mero no tiene usuario asignado, responde con `<Say>N√∫mero sin asignar</Say>`.
>
> **3. Optimizaci√≥n de Respuesta (Speed):**
> * Mant√©n el `setImmediate` para los logs, eso estuvo bien.
> * Aseg√∫rate de que la respuesta XML tenga el header `Content-Type: application/xml`.

***

### Explicaci√≥n del porqu√© "User Busy"
El agente ten√≠a raz√≥n en una cosa: El mensaje "User Busy" al colgar ocurr√≠a porque tu servidor devolv√≠a error o tardaba mucho, y Telnyx interpretaba "El servidor de control fall√≥" como "Ocupado". Al arreglar el Webhook para que responda r√°pido y con XML v√°lido (incluso en error), ese mensaje desaparecer√°.

Ejecuta el prompt de arriba para asegurar que los cables se conecten en el orden correcto.